#!/usr/bin/env python3
# test_vulnerability_manager.py

import sqlite3
import logging
from datetime import datetime
from db.schema import setup_database
from db.vulnerability_manager import VulnerabilityManager
from db.models import Vulnerability
import tempfile
import os

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

def test_vulnerability_manager_comprehensive():
    """
    –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ VulnerabilityManager
    """
    print("=" * 60)
    print("–ö–û–ú–ü–õ–ï–ö–°–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï VULNERABILITY MANAGER")
    print("=" * 60)
    
    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ë–î
    with tempfile.NamedTemporaryFile(suffix='.db', delete=False) as tmp_file:
        db_path = tmp_file.name
    
    try:
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ë–î
        setup_database(cursor)
        conn.commit()
        
        # –°–æ–∑–¥–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä
        vuln_manager = VulnerabilityManager()
        
        print("\n1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ Nuclei –¥–∞–Ω–Ω—ã—Ö...")
        test_nuclei_parsing(vuln_manager, cursor)
        conn.commit()
        
        # print("\n2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ Wapiti –¥–∞–Ω–Ω—ã—Ö...")  # –£–î–ê–õ–ï–ù–û: Wapiti –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
        # test_wapiti_parsing(vuln_manager, cursor)
        conn.commit()
        
        print("\n3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ Nmap –¥–∞–Ω–Ω—ã—Ö...")
        test_nmap_parsing(vuln_manager, cursor)
        conn.commit()
        
        print("\n4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ Gobuster –¥–∞–Ω–Ω—ã—Ö...")
        test_gobuster_parsing(vuln_manager, cursor)
        conn.commit()
        
        print("\n5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏...")
        test_deduplication(vuln_manager, cursor)
        conn.commit()
        
        print("\n6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏...")
        test_validation(vuln_manager, cursor)
        conn.commit()
        
        print("\n7. –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...")
        analyze_results(cursor)
        
        conn.close()
        
        print("\n" + "=" * 60)
        print("‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!")
        print("=" * 60)
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–∞—Ö: {e}")
        import traceback
        traceback.print_exc()
    finally:
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ë–î
        try:
            os.unlink(db_path)
        except:
            pass

def test_nuclei_parsing(vuln_manager: VulnerabilityManager, cursor):
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö Nuclei"""
    nuclei_data = [
        {
            'host': 'https://example.com',
            'info': {
                'name': 'SQL Injection in login form',
                'severity': 'High',
                'description': 'SQL injection vulnerability detected in login parameter',
                'cve': ['CVE-2023-1234']
            }
        },
        {
            'host': 'https://example.com/admin',
            'info': {
                'name': 'Cross-site scripting vulnerability',
                'severity': 'Medium',
                'description': 'XSS found in search parameter'
            }
        }
    ]
    
    stats = vuln_manager.process_and_save_vulnerabilities(
        raw_data=nuclei_data,
        scanner_name='nuclei',
        cursor=cursor,
        target_resource='https://example.com'
    )
    
    print(f"   Nuclei - –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {stats.processed}, –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {stats.saved_new}")
    assert stats.processed == 2
    assert stats.saved_new == 2

# –£–î–ê–õ–ï–ù–û: Wapiti –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
# def test_wapiti_parsing(vuln_manager: VulnerabilityManager, cursor):
#     """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö Wapiti"""
#     wapiti_data = {
#         'vulnerabilities': [
#             {
#                 'resource': 'https://example.com/files',
#                 'vulnerability_type': 'Path Traversal',
#                 'description': 'Directory traversal vulnerability in file parameter',
#                 'severity': 'Critical',
#                 'scanner': 'wapiti'
#             },
#             {
#                 'resource': 'https://example.com/login',
#                 'vulnerability_type': 'Default Credentials',
#                 'description': 'Default credentials admin:admin found',
#                 'severity': 'High',
#                 'scanner': 'wapiti'
#             }
#         ],
#         'target': 'https://example.com'
#     }
#     
#     stats = vuln_manager.process_and_save_vulnerabilities(
#         raw_data=wapiti_data,
#         scanner_name='wapiti',
#         cursor=cursor,
#         target_resource='https://example.com'
#     )
#     
#     print(f"   Wapiti - –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {stats.processed}, –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {stats.saved_new}")
#     assert stats.processed == 2
#     assert stats.saved_new == 2

def test_nmap_parsing(vuln_manager: VulnerabilityManager, cursor):
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö Nmap"""
    nmap_data = {
        'output': '''Starting Nmap scan...
        22/tcp   open  ssh     OpenSSH 7.4
        | vulners: 
        | CVE-2023-5678 7.5   CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
        80/tcp   open  http    Apache httpd 2.4.6
        | vulners:
        | CVE-2023-9999 9.8   CRITICAL vulnerability in Apache
        ''',
        'target': '192.168.1.100',
        'scanner': 'nmap'
    }
    
    stats = vuln_manager.process_and_save_vulnerabilities(
        raw_data=nmap_data,
        scanner_name='nmap',
        cursor=cursor,
        target_resource='192.168.1.100'
    )
    
    print(f"   Nmap - –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {stats.processed}, –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {stats.saved_new}")
    assert stats.processed >= 1  # –î–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —É—è–∑–≤–∏–º–æ—Å—Ç—å

def test_gobuster_parsing(vuln_manager: VulnerabilityManager, cursor):
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö Gobuster"""
    gobuster_data = {
        'output': '''Starting gobuster...
        /admin                (Status: 200) [Size: 1234]
        /config               (Status: 403) [Size: 567]
        /backup               (Status: 301) [Size: 0] [--> /backup/]
        /test                 (Status: 200) [Size: 890]
        ''',
        'target': 'https://example.com',
        'scanner': 'gobuster'
    }
    
    stats = vuln_manager.process_and_save_vulnerabilities(
        raw_data=gobuster_data,
        scanner_name='gobuster',
        cursor=cursor,
        target_resource='https://example.com'
    )
    
    print(f"   Gobuster - –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {stats.processed}, –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {stats.saved_new}")
    assert stats.processed >= 3  # –î–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏

def test_deduplication(vuln_manager: VulnerabilityManager, cursor):
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é"""
    # –ü–æ–≤—Ç–æ—Ä–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ Nuclei
    nuclei_data = [
        {
            'host': 'https://example.com',
            'info': {
                'name': 'SQL Injection in login form',
                'severity': 'High',
                'description': 'SQL injection vulnerability detected in login parameter'
            }
        }
    ]
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à —Å–µ—Å—Å–∏–∏ –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Ç–µ—Å—Ç–∞
    vuln_manager.reset_session_cache()
    
    stats = vuln_manager.process_and_save_vulnerabilities(
        raw_data=nuclei_data,
        scanner_name='nuclei',
        cursor=cursor,
        target_resource='https://example.com'
    )
    
    print(f"   –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è - –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {stats.processed}, –ü—Ä–æ–ø—É—â–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: {stats.duplicates_skipped}")
    assert stats.duplicates_skipped > 0  # –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞–π–¥–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã

def test_validation(vuln_manager: VulnerabilityManager, cursor):
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö"""
    # –¢–µ—Å—Ç —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    invalid_data = [
        {
            'host': '',  # –ü—É—Å—Ç–æ–π —Ä–µ—Å—É—Ä—Å
            'info': {
                'name': 'Test vulnerability',
                'severity': 'InvalidSeverity'  # –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å
            }
        }
    ]
    
    stats = vuln_manager.process_and_save_vulnerabilities(
        raw_data=invalid_data,
        scanner_name='test',
        cursor=cursor
    )
    
    print(f"   –í–∞–ª–∏–¥–∞—Ü–∏—è - –û—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: {stats.validation_errors}")
    assert stats.validation_errors > 0  # –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

def analyze_results(cursor):
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"""
    # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    cursor.execute("SELECT COUNT(*) FROM vulnerability")
    total_vulns = cursor.fetchone()[0]
    
    # –ü–æ —Å–∫–∞–Ω–µ—Ä–∞–º
    cursor.execute("SELECT scanner, COUNT(*) FROM vulnerability GROUP BY scanner")
    by_scanner = cursor.fetchall()
    
    # –ü–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏
    cursor.execute("""
        SELECT severity, COUNT(*) 
        FROM vulnerability 
        GROUP BY severity 
        ORDER BY CASE severity 
            WHEN 'Critical' THEN 1 
            WHEN 'High' THEN 2 
            WHEN 'Medium' THEN 3 
            WHEN 'Low' THEN 4 
            ELSE 5 
        END
    """)
    by_severity = cursor.fetchall()
    
    print(f"   –í—Å–µ–≥–æ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –ë–î: {total_vulns}")
    print("   –ü–æ —Å–∫–∞–Ω–µ—Ä–∞–º:")
    for scanner, count in by_scanner:
        print(f"     {scanner}: {count}")
    print("   –ü–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏:")
    for severity, count in by_severity:
        print(f"     {severity}: {count}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–¥–µ–∫—Å—ã
    cursor.execute("SELECT name FROM sqlite_master WHERE type='index' AND name LIKE 'idx_%'")
    indexes = cursor.fetchall()
    print(f"   –°–æ–∑–¥–∞–Ω–æ –∏–Ω–¥–µ–∫—Å–æ–≤: {len(indexes)}")

def test_performance():
    """–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"""
    print("\n" + "=" * 60)
    print("–¢–ï–°–¢ –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò")
    print("=" * 60)
    
    with tempfile.NamedTemporaryFile(suffix='.db', delete=False) as tmp_file:
        db_path = tmp_file.name
    
    try:
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ë–î
        setup_database(cursor)
        conn.commit()
        
        vuln_manager = VulnerabilityManager()
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        start_time = datetime.now()
        
        for i in range(100):
            test_data = [
                {
                    'host': f'https://example{i}.com',
                    'info': {
                        'name': f'Test vulnerability {i}',
                        'severity': 'Medium',
                        'description': f'Test description {i}'
                    }
                }
            ]
            
            vuln_manager.process_and_save_vulnerabilities(
                raw_data=test_data,
                scanner_name='performance_test',
                cursor=cursor,
                target_resource=f'https://example{i}.com'
            )
            
            if i % 20 == 0:
                conn.commit()
        
        conn.commit()
        end_time = datetime.now()
        
        duration = (end_time - start_time).total_seconds()
        print(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ 100 —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –∑–∞–Ω—è–ª–∞: {duration:.2f} —Å–µ–∫—É–Ω–¥")
        print(f"–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {100/duration:.1f} —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π/—Å–µ–∫")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        cursor.execute("SELECT COUNT(*) FROM vulnerability WHERE scanner = 'performance_test'")
        count = cursor.fetchone()[0]
        print(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π: {count}")
        
        conn.close()
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: {e}")
    finally:
        try:
            os.unlink(db_path)
        except:
            pass

if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ç–µ—Å—Ç—ã
    test_vulnerability_manager_comprehensive()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    test_performance()
    
    print("\nüéâ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!")
